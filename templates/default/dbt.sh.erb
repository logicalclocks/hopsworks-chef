#!/usr/bin/env bash

# This script allows Hopsworks to start/kill container for performing dbt jobs.
# This script can be run by hopsworks (running as user 'glassfish') as a sudo command whereupon

help() {
    echo ""
    echo "usage: $0 [start DBT_HOME CERTS_DIR HADOOP_USERNAME EXECUTION_ID PROJECT_ID HADOOP_GROUP LOG_PATH PROJECT_NAME ARGS DBT_PROJECT_PATH DBT_PROJECT_PROFILE] | [kill DBT_HOME HADOOP_USERNAME PROJECT_ID EXECUTION_ID PROJECT_USER_NAME]"
    exit 1
}

DOMAINS_DIR=<%= node['glassfish']['domains_dir'] %>
HOPSWORKS_USER=<%= node['hopsworks']['user'] %>
VALID_IMAGE_NAME='<%= node['conda']['docker']['image-validation-regex'] %>'

#DOMAINS_DIR=/srv/hops/domains
#DOMAINS_DIR=/srv/hops/domains
#DOMAINS_DIR=/srv/hops/domains
#DBT_USER=yarnapp
#DBT_GROUP=hadoop
#HOPSWORKS_USER=glassfish
#VALID_IMAGE_NAME='^([a-z0-9]+(-[a-z0-9]+)*.)*[a-z0-9]+(:[0-9]*)?(/([a-zA-Z0-9-]*))?/([-:._a-zA-Z0-9]{0,62}[-:.a-zA-Z0-9]$)'


if [ "$1" == "start" ] ; then

  if [ $# -ne 12 ]; then
   help
 fi

  DBT_HOME=$2
  CERTS_DIR=$3
  HADOOP_USERNAME=$4
  EXECUTION_ID=$5
  PROJECT_ID=$6
  HADOOP_GROUP=$7
  LOG_PATH=$8
  PROJECT_NAME=$9
  COMMANDS=${10}
  DBT_PROJECT_PATH=${11}
  DBT_PROJECT_PROFILE=${12}

   if [ ! -d "${DBT_HOME}" ]; then
    echo "Invalid DBT_HOME directory: ${DBT_HOME}"
          exit 2
  fi

  if [ ! -d "${CERTS_DIR}" ]; then
    echo "Invalid CERTS_DIR directory: ${CERTS_DIR}"
          exit 3
  fi
  if [ ! -d "${LOG_PATH}" ]; then
    echo "Invalid LOG_PATH directory: ${LOG_PATH}"
          exit 4
  fi


#  if [ ! -d "${DBT_PROJECT_PATH}" ]; then
#    echo "Invalid DBT_PROJECT_PATH directory: ${DBT_PROJECT_PATH}"
#          exit 5
#  fi


#  chmod 0730 "$DBT_HOME"
#  chown -R "${DBT_USER}":"${DBT_GROUP}" "${DBT_HOME}"
  chmod -R 770 "${DBT_HOME}"

  echo "run dbt-container-launch.sh"
  ${DOMAINS_DIR}/domain1/bin/dbt-container-launch.sh "${DBT_HOME}" "${CERTS_DIR}" "${HADOOP_USERNAME}" "${EXECUTION_ID}" "${PROJECT_ID}" "${HADOOP_GROUP}" "${LOG_PATH}" "${PROJECT_NAME}" "${COMMANDS}" "${DBT_PROJECT_PATH}" "${DBT_PROJECT_PROFILE}"

elif [ "$1" == "kill" ] ; then
  echo "killing dbt job execution $1, $2, $3, $4, $5, $6"

  if [ $# -ne 6 ]; then
          help
  fi

  sudo ${DOMAINS_DIR}/domain1/bin/dbt-container-kill.sh $3 $4 $5 $6
  echo $2
  # Remove all the directories in the home dbt folder for this execution.
#  if [ "$2" != "" ] ; then
#    rm -rf "${2}"
#  fi

elif [ "$1" == "list" ] ; then
  echo "docker list test"
else
  help
fi

exit $?
